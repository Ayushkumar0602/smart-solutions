<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Timer - Settings</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- Firebase SDKs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    
    <style>
        /* CSS Variables for Theme Management */
        :root {
            /* Light Theme Variables */
            --primary-color: #6366f1;
            --primary-hover: #5855eb;
            --primary-dark: #4f46e5;
            --secondary-color: #f3f4f6;
            --background-color: #ffffff;
            --surface-color: #f8fafc;
            --card-background: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --border-color: #e5e7eb;
            --border-hover: #d1d5db;
            --shadow-light: rgba(0, 0, 0, 0.05);
            --shadow-medium: rgba(0, 0, 0, 0.1);
            --shadow-heavy: rgba(0, 0, 0, 0.25);
            --success-color: #10b981;
            --success-background: #ecfdf5;
            --success-border: #a7f3d0;
            --error-color: #ef4444;
            --error-background: #fef2f2;
            --error-border: #fecaca;
            --warning-color: #f59e0b;
            --warning-background: #fffbeb;
            --warning-border: #fed7aa;
            --info-color: #3b82f6;
            --info-background: #eff6ff;
            --info-border: #bfdbfe;
            --toggle-bg: #e5e7eb;
            --toggle-checked: var(--primary-color);
            --toggle-thumb: #ffffff;
            --navbar-bg: var(--card-background);
            --navbar-shadow: var(--shadow-medium);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Dark Theme Variables */
        [data-theme="dark"] {
            --primary-color: #818cf8;
            --primary-hover: #a5b4fc;
            --primary-dark: #6366f1;
            --secondary-color: #374151;
            --background-color: #111827;
            --surface-color: #1f2937;
            --card-background: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-tertiary: #9ca3af;
            --border-color: #374151;
            --border-hover: #4b5563;
            --shadow-light: rgba(0, 0, 0, 0.3);
            --shadow-medium: rgba(0, 0, 0, 0.4);
            --shadow-heavy: rgba(0, 0, 0, 0.6);
            --success-color: #34d399;
            --success-background: #064e3b;
            --success-border: #065f46;
            --error-color: #f87171;
            --error-background: #7f1d1d;
            --error-border: #991b1b;
            --warning-color: #fbbf24;
            --warning-background: #78350f;
            --warning-border: #92400e;
            --info-color: #60a5fa;
            --info-background: #1e3a8a;
            --info-border: #1d4ed8;
            --toggle-bg: #374151;
            --toggle-checked: var(--primary-color);
            --toggle-thumb: #ffffff;
            --navbar-bg: var(--card-background);
            --navbar-shadow: rgba(0, 0, 0, 0.5);
        }

        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--background-color) 0%, var(--surface-color) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            transition: var(--transition);
            overflow-x: hidden;
        }

        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Navigation Header */
        .navbar {
            background: var(--navbar-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px var(--shadow-light);
            backdrop-filter: blur(10px);
            transition: var(--transition);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            color: var(--text-primary);
            font-weight: 700;
            font-size: 1.5rem;
            transition: var(--transition);
        }

        .nav-brand:hover {
            color: var(--primary-color);
            transform: translateY(-1px);
        }

        .nav-brand .brand-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 12px var(--shadow-medium);
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 50px;
            transition: var(--transition);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .user-email {
            color: var(--text-secondary);
            font-size: 0.875rem;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Main Container */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            min-height: calc(100vh - 80px);
        }

        /* Page Header */
        .page-header {
            text-align: center;
            margin-bottom: 3rem;
            animation: fadeInUp 0.6s ease-out;
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 1.125rem;
            max-width: 500px;
            margin: 0 auto;
        }

        /* Settings Card */
        .settings-card {
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px var(--shadow-light);
            transition: var(--transition);
            animation: fadeInUp 0.6s ease-out 0.2s both;
        }

        .settings-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px var(--shadow-medium);
        }

        /* Settings Section */
        .settings-section {
            margin-bottom: 2.5rem;
        }

        .settings-section:last-child {
            margin-bottom: 0;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .section-icon {
            width: 24px;
            height: 24px;
            color: var(--primary-color);
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .section-description {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-left: auto;
            text-align: right;
            max-width: 200px;
        }

        /* Setting Item */
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 1rem;
            transition: var(--transition);
        }

        .setting-item:hover {
            background: var(--card-background);
            border-color: var(--border-hover);
            transform: translateX(4px);
        }

        .setting-item:last-child {
            margin-bottom: 0;
        }

        .setting-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .setting-label {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .setting-description {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.4;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--toggle-bg);
            border: 1px solid var(--border-color);
            transition: var(--transition);
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: var(--toggle-thumb);
            transition: var(--transition);
            border-radius: 50%;
            box-shadow: 0 2px 4px var(--shadow-medium);
        }

        input:checked + .toggle-slider {
            background-color: var(--toggle-checked);
            border-color: var(--toggle-checked);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        input:focus + .toggle-slider {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        /* Theme Selector */
        .theme-selector {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .theme-option {
            flex: 1;
            min-width: 120px;
            position: relative;
        }

        .theme-radio {
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
        }

        .theme-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            background: var(--surface-color);
        }

        .theme-label:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .theme-radio:checked + .theme-label {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
        }

        .theme-preview {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .theme-preview.light {
            background: linear-gradient(135deg, #ffffff, #f3f4f6);
            border: 2px solid #e5e7eb;
        }

        .theme-preview.dark {
            background: linear-gradient(135deg, #1f2937, #111827);
            border: 2px solid #374151;
        }

        .theme-name {
            font-weight: 500;
            font-size: 0.875rem;
            text-align: center;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 120px;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: var(--surface-color);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--card-background);
            border-color: var(--primary-color);
            color: var(--primary-color);
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Notification Messages */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            min-width: 300px;
            box-shadow: 0 4px 20px var(--shadow-heavy);
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, var(--success-color), #059669);
        }

        .notification.error {
            background: linear-gradient(135deg, var(--error-color), #dc2626);
        }

        .notification.warning {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
        }

        .notification.info {
            background: linear-gradient(135deg, var(--info-color), #2563eb);
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .nav-container {
                padding: 0 1rem;
            }

            .page-title {
                font-size: 2rem;
            }

            .settings-card {
                padding: 1.5rem;
            }

            .setting-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .setting-item .toggle-switch {
                align-self: flex-end;
            }

            .theme-selector {
                flex-direction: column;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .user-email {
                display: none;
            }

            .notification {
                right: 10px;
                left: 10px;
                min-width: auto;
            }
        }

        @media (max-width: 480px) {
            .nav-brand .brand-text {
                display: none;
            }

            .page-title {
                font-size: 1.75rem;
            }

            .settings-card {
                padding: 1rem;
            }

            .section-description {
                display: none;
            }
        }

        /* Focus and Accessibility */
        .btn:focus,
        .toggle-switch input:focus + .toggle-slider,
        .theme-radio:focus + .theme-label {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--surface-color);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }

        /* Print Styles */
        @media print {
            .navbar,
            .action-buttons,
            .notification {
                display: none !important;
            }

            .settings-card {
                box-shadow: none;
                border: 1px solid #000;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Navigation Header -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="dashboard.html" class="nav-brand">
                <div class="brand-icon">P</div>
                <span class="brand-text">Pomodoro Timer</span>
            </a>
            
            <div class="nav-actions">
                <div class="user-info" id="userInfo">
                    <div class="user-avatar" id="userAvatar"></div>
                    <span class="user-email" id="userEmail"></span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">Settings</h1>
            <p class="page-subtitle">Customize your Pomodoro Timer experience with theme and notification preferences</p>
        </div>

        <!-- Settings Card -->
        <div class="settings-card">
            <!-- Theme Settings Section -->
            <div class="settings-section">
                <div class="section-header">
                    <svg class="section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zM21 5a2 2 0 00-2-2h-4a2 2 0 00-2 2v12a4 4 0 004 4h4a2 2 0 002-2V5z"></path>
                    </svg>
                    <h2 class="section-title">Theme Preferences</h2>
                    <p class="section-description">Choose your preferred theme</p>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <label class="setting-label">App Theme</label>
                        <p class="setting-description">Select between light and dark theme for your Pomodoro Timer interface</p>
                    </div>
                    
                    <div class="theme-selector">
                        <div class="theme-option">
                            <input type="radio" id="lightTheme" name="theme" value="light" class="theme-radio">
                            <label for="lightTheme" class="theme-label">
                                <div class="theme-preview light">‚òÄÔ∏è</div>
                                <span class="theme-name">Light</span>
                            </label>
                        </div>
                        
                        <div class="theme-option">
                            <input type="radio" id="darkTheme" name="theme" value="dark" class="theme-radio">
                            <label for="darkTheme" class="theme-label">
                                <div class="theme-preview dark">üåô</div>
                                <span class="theme-name">Dark</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notification Settings Section -->
            <div class="settings-section">
                <div class="section-header">
                    <svg class="section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5l-5-5h5V3h5v14z"></path>
                    </svg>
                    <h2 class="section-title">Notification Preferences</h2>
                    <p class="section-description">Manage your alerts and notifications</p>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <label for="pomodoroNotifications" class="setting-label">Pomodoro Complete Notifications</label>
                        <p class="setting-description">Get notified when your Pomodoro session is complete and it's time for a break</p>
                    </div>
                    
                    <label class="toggle-switch">
                        <input type="checkbox" id="pomodoroNotifications">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <label for="breakNotifications" class="setting-label">Break Complete Notifications</label>
                        <p class="setting-description">Get notified when your break is over and it's time to start the next Pomodoro session</p>
                    </div>
                    
                    <label class="toggle-switch">
                        <input type="checkbox" id="breakNotifications">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button type="button" class="btn btn-primary" id="saveSettingsBtn">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Save Settings
                </button>
                
                <a href="dashboard.html" class="btn btn-secondary">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyABwi4-Rzl7T1qGLyWAWIAFcUxEivSX_BE",
            authDomain: "whizan-coding--agent.firebaseapp.com",
            projectId: "whizan-coding--agent",
            storageBucket: "whizan-coding--agent.firebasestorage.app",
            messagingSenderId: "798036544047",
            appId: "1:798036544047:web:ff7f8d3c44f40087e8d4da",
            measurementId: "G-8DJEL3Q4RH"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global Variables
        let currentUser = null;
        let userSettings = {
            theme: 'light',
            notifications: {
                pomodoroComplete: true,
                breakComplete: true
            }
        };

        // DOM Elements
        const elements = {
            loadingOverlay: document.getElementById('loadingOverlay'),
            userInfo: document.getElementById('userInfo'),
            userAvatar: document.getElementById('userAvatar'),
            userEmail: document.getElementById('userEmail'),
            lightThemeRadio: document.getElementById('lightTheme'),
            darkThemeRadio: document.getElementById('darkTheme'),
            pomodoroNotifications: document.getElementById('pomodoroNotifications'),
            breakNotifications: document.getElementById('breakNotifications'),
            saveSettingsBtn: document.getElementById('saveSettingsBtn')
        };

        // Utility Functions
        const utils = {
            // Show loading overlay
            showLoading() {
                elements.loadingOverlay.classList.add('active');
            },

            // Hide loading overlay
            hideLoading() {
                elements.loadingOverlay.classList.remove('active');
            },

            // Show notification
            showNotification(message, type = 'info', duration = 4000) {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
                        <span>${message}</span>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Trigger animation
                setTimeout(() => notification.classList.add('show'), 100);
                
                // Auto remove
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }, duration);
            },

            // Validate email format
            isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            },

            // Get user initials from email
            getUserInitials(email) {
                if (!email) return 'U';
                const parts = email.split('@')[0].split('.');
                if (parts.length >= 2) {
                    return (parts[0].charAt(0) + parts[1].charAt(0)).toUpperCase();
                }
                return email.charAt(0).toUpperCase();
            },

            // Debounce function for performance
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            // Validate settings data
            validateSettings(settings) {
                const errors = [];

                // Validate theme
                if (!settings.theme || !['light', 'dark'].includes(settings.theme)) {
                    errors.push('Theme must be either "light" or "dark"');
                }

                // Validate notifications object
                if (!settings.notifications || typeof settings.notifications !== 'object') {
                    errors.push('Notifications must be an object');
                } else {
                    // Validate notification properties
                    if (typeof settings.notifications.pomodoroComplete !== 'boolean') {
                        errors.push('Pomodoro complete notification must be a boolean');
                    }
                    if (typeof settings.notifications.breakComplete !== 'boolean') {
                        errors.push('Break complete notification must be a boolean');
                    }
                }

                return {
                    isValid: errors.length === 0,
                    errors
                };
            },

            // Apply theme to document
            applyTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                
                // Add animation class for smooth transition
                document.body.style.transition = 'all 0.3s ease';
                setTimeout(() => {
                    document.body.style.transition = '';
                }, 300);
            },

            // Format timestamp
            formatTimestamp(timestamp) {
                if (!timestamp) return 'Never';
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toLocaleString();
            }
        };

        // Theme Management
        const themeManager = {
            // Initialize theme
            init() {
                // Check for saved theme or default to light
                const savedTheme = localStorage.getItem('theme') || 'light';
                this.setTheme(savedTheme);
                
                // Listen for theme changes
                elements.lightThemeRadio.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        this.setTheme('light');
                        userSettings.theme = 'light';
                    }
                });

                elements.darkThemeRadio.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        this.setTheme('dark');
                        userSettings.theme = 'dark';
                    }
                });

                // Listen for system theme changes
                if (window.matchMedia) {
                    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                    mediaQuery.addListener((e) => {
                        if (!localStorage.getItem('theme')) {
                            this.setTheme(e.matches ? 'dark' : 'light');
                        }
                    });
                }
            },

            // Set theme
            setTheme(theme) {
                utils.applyTheme(theme);
                
                // Update radio buttons
                if (theme === 'light') {
                    elements.lightThemeRadio.checked = true;
                } else {
                    elements.darkThemeRadio.checked = true;
                }
            },

            // Get current theme
            getCurrentTheme() {
                return document.documentElement.getAttribute('data-theme') || 'light';
            }
        };

        // Authentication Management
        const authManager = {
            // Initialize authentication
            init() {
                utils.showLoading();
                
                // Listen for auth state changes
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        currentUser = user;
                        this.handleAuthenticatedUser(user);
                    } else {
                        this.handleUnauthenticatedUser();
                    }
                });
            },

            // Handle authenticated user
            async handleAuthenticatedUser(user) {
                try {
                    // Update user info in navbar
                    this.updateUserInfo(user);
                    
                    // Load user settings
                    await settingsManager.loadUserSettings(user.uid);
                    
                    utils.hideLoading();
                } catch (error) {
                    console.error('Error handling authenticated user:', error);
                    utils.showNotification('Error loading user data', 'error');
                    utils.hideLoading();
                }
            },

            // Handle unauthenticated user
            handleUnauthenticatedUser() {
                utils.hideLoading();
                utils.showNotification('Please log in to access settings', 'warning');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            },

            // Update user info in navbar
            updateUserInfo(user) {
                const email = user.email || 'user@example.com';
                const initials = utils.getUserInitials(email);
                
                elements.userAvatar.textContent = initials;
                elements.userEmail.textContent = email;
                elements.userInfo.style.display = 'flex';
            },

            // Sign out user
            async signOut() {
                try {
                    utils.showLoading();
                    await auth.signOut();
                    utils.hideLoading();
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Error signing out:', error);
                    utils.showNotification('Error signing out', 'error');
                    utils.hideLoading();
                }
            }
        };

        // Settings Management
        const settingsManager = {
            // Load user settings from Firestore
            async loadUserSettings(userId) {
                try {
                    const userDoc = await db.collection('users').doc(userId).get();
                    
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        
                        // Merge with default settings
                        userSettings = {
                            theme: userData.theme || 'light',
                            notifications: {
                                pomodoroComplete: userData.notifications?.pomodoroComplete ?? true,
                                breakComplete: userData.notifications?.breakComplete ?? true
                            }
                        };
                    } else {
                        // Create user document with default settings
                        await this.createUserDocument(userId);
                    }
                    
                    // Apply loaded settings
                    this.applySettingsToUI();
                    
                } catch (error) {
                    console.error('Error loading user settings:', error);
                    utils.showNotification('Error loading settings', 'error');
                    
                    // Use default settings
                    this.applySettingsToUI();
                }
            },

            // Create user document with default settings
            async createUserDocument(userId) {
                try {
                    const defaultUserData = {
                        email: currentUser.email,
                        displayName: currentUser.displayName || null,
                        theme: 'light',
                        notifications: {
                            pomodoroComplete: true,
                            breakComplete: true
                        },
                        settings: {
                            pomodoroLength: 25,
                            shortBreakLength: 5,
                            longBreakLength: 15,
                            sessionsUntilLongBreak: 4,
                            autoStartBreaks: false,
                            autoStartPomodoros: false,
                            soundEnabled: true,
                            tickingSound: false
                        },
                        stats: {
                            totalPomodoros: 0,
                            totalFocusTime: 0,
                            totalBreakTime: 0,
                            streak: 0,
                            lastActivity: null
                        },
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    await db.collection('users').doc(userId).set(defaultUserData);
                    
                    // Update local settings
                    userSettings = {
                        theme: defaultUserData.theme,
                        notifications: defaultUserData.notifications
                    };
                    
                } catch (error) {
                    console.error('Error creating user document:', error);
                    throw error;
                }
            },

            // Apply settings to UI elements
            applySettingsToUI() {
                // Apply theme
                themeManager.setTheme(userSettings.theme);
                
                // Apply notification settings
                elements.pomodoroNotifications.checked = userSettings.notifications.pomodoroComplete;
                elements.breakNotifications.checked = userSettings.notifications.breakComplete;
            },

            // Collect settings from UI
            collectSettingsFromUI() {
                return {
                    theme: elements.lightThemeRadio.checked ? 'light' : 'dark',
                    notifications: {
                        pomodoroComplete: elements.pomodoroNotifications.checked,
                        breakComplete: elements.breakNotifications.checked
                    }
                };
            },

            // Save settings to Firestore
            async saveSettings() {
                if (!currentUser) {
                    utils.showNotification('Please log in to save settings', 'error');
                    return false;
                }

                try {
                    utils.showLoading();
                    
                    // Collect settings from UI
                    const newSettings = this.collectSettingsFromUI();
                    
                    // Validate settings
                    const validation = utils.validateSettings(newSettings);
                    if (!validation.isValid) {
                        utils.showNotification(`Invalid settings: ${validation.errors.join(', ')}`, 'error');
                        utils.hideLoading();
                        return false;
                    }
                    
                    // Update user document in Firestore
                    await db.collection('users').doc(currentUser.uid).update({
                        theme: newSettings.theme,
                        notifications: newSettings.notifications,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update local settings
                    userSettings = { ...newSettings };
                    
                    // Apply theme immediately
                    themeManager.setTheme(newSettings.theme);
                    
                    utils.hideLoading();
                    utils.showNotification('Settings saved successfully!', 'success');
                    
                    return true;
                    
                } catch (error) {
                    console.error('Error saving settings:', error);
                    utils.hideLoading();
                    utils.showNotification('Error saving settings. Please try again.', 'error');
                    return false;
                }
            },

            // Setup real-time listener for settings changes
            setupRealtimeListener() {
                if (!currentUser) return;

                const unsubscribe = db.collection('users').doc(currentUser.uid)
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            const userData = doc.data();
                            
                            // Check if settings have changed
                            const newSettings = {
                                theme: userData.theme || 'light',
                                notifications: {
                                    pomodoroComplete: userData.notifications?.pomodoroComplete ?? true,
                                    breakComplete: userData.notifications?.breakComplete ?? true
                                }
                            };
                            
                            // Only update if settings have actually changed
                            if (JSON.stringify(newSettings) !== JSON.stringify(userSettings)) {
                                userSettings = newSettings;
                                this.applySettingsToUI();
                                utils.showNotification('Settings updated from another device', 'info', 3000);
                            }
                        }
                    }, (error) => {
                        console.error('Error listening to settings changes:', error);
                    });

                // Store unsubscribe function for cleanup
                window.settingsUnsubscribe = unsubscribe;
            }
        };

        // Notification Management
        const notificationManager = {
            // Initialize notifications
            init() {
                this.checkPermission();
                this.setupNotificationListeners();
            },

            // Check notification permission
            async checkPermission() {
                if (!('Notification' in window)) {
                    console.log('This browser does not support notifications');
                    return false;
                }

                if (Notification.permission === 'granted') {
                    return true;
                } else if (Notification.permission !== 'denied') {
                    const permission = await Notification.requestPermission();
                    return permission === 'granted';
                }

                return false;
            },

            // Setup notification listeners
            setupNotificationListeners() {
                elements.pomodoroNotifications.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        this.checkPermission();
                    }
                });

                elements.breakNotifications.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        this.checkPermission();
                    }
                });
            },

            // Send test notification
            async sendTestNotification(type) {
                const hasPermission = await this.checkPermission();
                if (!hasPermission) {
                    utils.showNotification('Notification permission required', 'warning');
                    return;
                }

                const messages = {
                    pomodoro: {
                        title: 'Pomodoro Complete! üçÖ',
                        body: 'Great work! Time for a well-deserved break.',
                        icon: '/favicon.ico'
                    },
                    break: {
                        title: 'Break Complete! ‚è∞',
                        body: 'Break time is over. Ready for your next Pomodoro?',
                        icon: '/favicon.ico'
                    }
                };

                const config = messages[type];
                if (config) {
                    new Notification(config.title, {
                        body: config.body,
                        icon: config.icon,
                        requireInteraction: false,
                        silent: false
                    });
                }
            }
        };

        // Event Listeners
        const eventListeners = {
            // Initialize all event listeners
            init() {
                this.setupSaveButton();
                this.setupKeyboardShortcuts();
                this.setupFormValidation();
                this.setupThemeToggle();
                this.setupNotificationToggles();
            },

            // Setup save button
            setupSaveButton() {
                elements.saveSettingsBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    
                    // Disable button during save
                    elements.saveSettingsBtn.disabled = true;
                    elements.saveSettingsBtn.innerHTML = `
                        <div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>
                        Saving...
                    `;
                    
                    const success = await settingsManager.saveSettings();
                    
                    // Re-enable button
                    elements.saveSettingsBtn.disabled = false;
                    elements.saveSettingsBtn.innerHTML = `
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Save Settings
                    `;
                });
            },

            // Setup keyboard shortcuts
            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    // Ctrl/Cmd + S to save
                    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                        e.preventDefault();
                        elements.saveSettingsBtn.click();
                    }
                    
                    // Escape to go back
                    if (e.key === 'Escape') {
                        window.location.href = 'dashboard.html';
                    }
                    
                    // Ctrl/Cmd + D to toggle theme
                    if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                        e.preventDefault();
                        const currentTheme = themeManager.getCurrentTheme();
                        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                        themeManager.setTheme(newTheme);
                        userSettings.theme = newTheme;
                    }
                });
            },

            // Setup form validation
            setupFormValidation() {
                // Real-time validation feedback
                const debouncedValidation = utils.debounce(() => {
                    const settings = settingsManager.collectSettingsFromUI();
                    const validation = utils.validateSettings(settings);
                    
                    elements.saveSettingsBtn.disabled = !validation.isValid;
                    
                    if (!validation.isValid) {
                        elements.saveSettingsBtn.title = `Invalid settings: ${validation.errors.join(', ')}`;
                    } else {
                        elements.saveSettingsBtn.title = 'Save your settings';
                    }
                }, 300);

                // Add validation listeners
                [elements.lightThemeRadio, elements.darkThemeRadio, 
                 elements.pomodoroNotifications, elements.breakNotifications].forEach(element => {
                    element.addEventListener('change', debouncedValidation);
                });
            },

            // Setup theme toggle
            setupThemeToggle() {
                // Add click animation to theme options
                document.querySelectorAll('.theme-label').forEach(label => {
                    label.addEventListener('click', () => {
                        label.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            label.style.transform = '';
                        }, 150);
                    });
                });
            },

            // Setup notification toggles
            setupNotificationToggles() {
                // Add test notification buttons (for development)
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    const testButtons = document.createElement('div');
                    testButtons.innerHTML = `
                        <div style="margin-top: 1rem; text-align: center; opacity: 0.7;">
                            <small>Development Mode:</small>
                            <button type="button" onclick="notificationManager.sendTestNotification('pomodoro')" 
                                    style="margin: 0 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                Test Pomodoro Notification
                            </button>
                            <button type="button" onclick="notificationManager.sendTestNotification('break')" 
                                    style="margin: 0 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                Test Break Notification
                            </button>
                        </div>
                    `;
                    document.querySelector('.settings-card').appendChild(testButtons);
                }
            }
        };

        // Performance Monitoring
        const performanceMonitor = {
            // Initialize performance monitoring
            init() {
                this.monitorPageLoad();
                this.monitorUserInteractions();
            },

            // Monitor page load performance
            monitorPageLoad() {
                window.addEventListener('load', () => {
                    if ('performance' in window && 'timing' in performance) {
                        const timing = performance.timing;
                        const loadTime = timing.loadEventEnd - timing.navigationStart;
                        console.log(`Settings page loaded in ${loadTime}ms`);
                        
                        // Log to analytics if available
                        if (window.gtag) {
                            gtag('event', 'page_load_time', {
                                event_category: 'Performance',
                                value: loadTime,
                                custom_map: { metric1: 'load_time' }
                            });
                        }
                    }
                });
            },

            // Monitor user interactions
            monitorUserInteractions() {
                let interactionCount = 0;
                
                document.addEventListener('click', () => {
                    interactionCount++;
                });
                
                document.addEventListener('change', () => {
                    interactionCount++;
                });
                
                // Log interaction count on page unload
                window.addEventListener('beforeunload', () => {
                    console.log(`User interactions: ${interactionCount}`);
                });
            }
        };

        // Error Handling
        const errorHandler = {
            // Initialize error handling
            init() {
                this.setupGlobalErrorHandlers();
                this.setupUnhandledPromiseRejection();
            },

            // Setup global error handlers
            setupGlobalErrorHandlers() {
                window.addEventListener('error', (event) => {
                    console.error('Global error:', event.error);
                    this.logError('JavaScript Error', event.error);
                    
                    // Show user-friendly message
                    if (!event.error.message.includes('Firebase')) {
                        utils.showNotification('An unexpected error occurred', 'error');
                    }
                });
            },

            // Setup unhandled promise rejection handler
            setupUnhandledPromiseRejection() {
                window.addEventListener('unhandledrejection', (event) => {
                    console.error('Unhandled promise rejection:', event.reason);
                    this.logError('Promise Rejection', event.reason);
                    
                    // Prevent the default handler
                    event.preventDefault();
                    
                    // Show user-friendly message
                    utils.showNotification('An error occurred while processing your request', 'error');
                });
            },

            // Log error to console and potentially to analytics
            logError(type, error) {
                const errorInfo = {
                    type: type,
                    message: error.message || error,
                    stack: error.stack || 'No stack trace',
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    url: window.location.href
                };
                
                console.error('Error logged:', errorInfo);
                
                // Log to analytics if available
                if (window.gtag) {
                    gtag('event', 'exception', {
                        description: `${type}: ${error.message || error}`,
                        fatal: false
                    });
                }
            }
        };

        // App Initialization
        const app = {
            // Initialize the entire application
            async init() {
                try {
                    console.log('Initializing Pomodoro Timer Settings...');
                    
                    // Initialize components in order
                    errorHandler.init();
                    themeManager.init();
                    notificationManager.init();
                    eventListeners.init();
                    performanceMonitor.init();
                    
                    // Initialize authentication (this will load settings)
                    authManager.init();
                    
                    console.log('Settings page initialized successfully');
                    
                } catch (error) {
                    console.error('Error initializing app:', error);
                    utils.hideLoading();
                    utils.showNotification('Error initializing application', 'error');
                }
            },

            // Cleanup function for page unload
            cleanup() {
                // Unsubscribe from real-time listeners
                if (window.settingsUnsubscribe) {
                    window.settingsUnsubscribe();
                }
                
                // Clear any remaining timeouts/intervals
                // (Add specific cleanup code as needed)
            }
        };

        // Page Lifecycle Management
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

        window.addEventListener('beforeunload', () => {
            app.cleanup();
        });

        // Make certain functions globally available for debugging
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            window.debugSettings = {
                utils,
                themeManager,
                authManager,
                settingsManager,
                notificationManager,
                userSettings,
                currentUser
            };
        }

        // Service Worker Registration (for PWA functionality)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('ServiceWorker registered:', registration);
                } catch (error) {
                    console.log('ServiceWorker registration failed:', error);
                }
            });
        }

        // Accessibility Enhancements
        document.addEventListener('keydown', (e) => {
            // Enhanced keyboard navigation
            if (e.key === 'Tab') {
                document.body.classList.add('keyboard-navigation');
            }
        });

        document.addEventListener('mousedown', () => {
            document.body.classList.remove('keyboard-navigation');
        });

        // Add custom styles for keyboard navigation
        const keyboardNavStyle = document.createElement('style');
        keyboardNavStyle.textContent = `
            .keyboard-navigation *:focus {
                outline: 2px solid var(--primary-color) !important;
                outline-offset: 2px !important;
            }
        `;
        document.head.appendChild(keyboardNavStyle);

        // Mobile responsiveness enhancements
        const handleOrientationChange = () => {
            // Adjust layout on orientation change
            setTimeout(() => {
                window.dispatchEvent(new Event('resize'));
            }, 100);
        };

        window.addEventListener('orientationchange', handleOrientationChange);

        // Performance optimization for mobile
        if ('connection' in navigator) {
            const connection = navigator.connection;
            if (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
                // Reduce animations for slow connections
                document.body.classList.add('reduced-motion');
                
                const reducedMotionStyle = document.createElement('style');
                reducedMotionStyle.textContent = `
                    .reduced-motion *,
                    .reduced-motion *::before,
                    .reduced-motion *::after {
                        animation-duration: 0.01ms !important;
                        animation-iteration-count: 1 !important;
                        transition-duration: 0.01ms !important;
                    }
                `;
                document.head.appendChild(reducedMotionStyle);
            }
        }
    </script>
</body>
</html>